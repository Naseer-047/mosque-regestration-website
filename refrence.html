<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mosque Registry — Town</title>
  <style>
    :root{--bg:#f5f7fb;--card:#ffffff;--accent:#0b63d6;--muted:#666}
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system,Segoe UI, Roboto, "Helvetica Neue", Arial; margin:0; background:var(--bg); color:#111}
    header{background:linear-gradient(90deg,#006eff, #4b9bf5); color:#fff; padding:18px 20px}
    header h1{margin:0;font-size:20px}
    .container{max-width:1100px;margin:22px auto;padding:0 18px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(15,20,40,0.06)}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type=text], input[type=tel], input[type=email], select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}
    textarea{min-height:80px}
    .row{display:flex;gap:10px}
    .row .col{flex:1}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-ghost{background:transparent;border:1px solid #ddd}
    h2{margin:0 0 10px 0;font-size:16px}
    .small{font-size:13px;color:var(--muted)}
    .members-list{max-height:240px;overflow:auto;margin-top:8px}
    .member-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;border:1px solid #f0f2f6;margin-bottom:8px}
    .member-row div{display:flex;gap:10px;align-items:center}
    .controls{display:flex;gap:8px}
    .search{display:flex;gap:8px;margin-bottom:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid #f1f3f8;text-align:left;font-size:14px}
    .empty{padding:20px;text-align:center;color:var(--muted)}
    footer{max-width:1100px;margin:12px auto; padding:10px 18px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <header>
    <h1>Mosque Registry — Town</h1>
  </header>

  <main class="container">
    <div class="grid">
      <!-- Left: Form + Mosque list -->
      <section>
        <div class="card">
          <h2>Register / Edit Mosque</h2>
          <p class="small">Add mosque details and its members. Data is saved to your browser (localStorage).</p>

          <div style="margin-top:12px">
            <label>Mosque Name</label>
            <input id="mosqueName" type="text" placeholder="e.g. Al Noor Masjid" />

            <div class="row" style="margin-top:8px">
              <div class="col">
                <label>District / Town</label>
                <input id="mosqueDistrict" type="text" placeholder="e.g. Old Town" />
              </div>
              <div class="col">
                <label>Ward / Area (optional)</label>
                <input id="mosqueArea" type="text" placeholder="e.g. Ward 5" />
              </div>
            </div>

            <div class="row" style="margin-top:8px">
              <div class="col">
                <label>Contact Phone</label>
                <input id="mosquePhone" type="tel" placeholder="e.g. +91 98765 43210" />
              </div>
              <div class="col">
                <label>Email (optional)</label>
                <input id="mosqueEmail" type="email" placeholder="info@masjid.example" />
              </div>
            </div>

            <label style="margin-top:8px">Address</label>
            <textarea id="mosqueAddress" placeholder="Full address, landmarks"></textarea>

            <hr style="margin:12px 0;border:none;border-top:1px solid #f0f2f6" />

            <h2 style="font-size:15px;margin-bottom:8px">Members / Contacts</h2>
            <div class="row">
              <input id="memberName" type="text" placeholder="Member name" />
              <input id="memberPhone" type="tel" placeholder="Phone" />
              <button id="addMemberBtn" class="btn btn-primary">Add</button>
            </div>
            <div class="members-list" id="membersList"></div>

            <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
              <button id="saveMosque" class="btn btn-primary">Save Mosque</button>
              <button id="resetForm" class="btn btn-ghost">Reset</button>
              <div style="margin-left:auto" class="small">Saved locally. Use Export to backup.</div>
            </div>
          </div>
        </div>

        <div style="height:18px"></div>

        <div class="card">
          <h2>Registered Mosques</h2>
          <div class="search">
            <input id="searchInput" type="text" placeholder="Search by name, district, phone..." />
            <select id="filterDistrict"><option value="">All Districts</option></select>
            <button id="exportBtn" class="btn btn-ghost">Export CSV</button>
          </div>

          <div id="mosqueTableArea"></div>
        </div>
      </section>

      <!-- Right: Quick info / preview -->
      <aside>
        <div class="card">
          <h2>Preview</h2>
          <div id="previewArea">
            <div class="empty">No mosque selected — fill the form to see preview.</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <h2>Quick Actions</h2>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button id="randomFill" class="btn btn-ghost">Random sample data</button>
            <button id="clearAll" class="btn btn-ghost">Clear all saved data</button>
          </div>
          <p class="small" style="margin-top:8px">Important: Clear will remove all saved mosques from this browser.</p>
        </div>
      </aside>
    </div>
  </main>

  <footer>Built for Town Mosque Registry • Data stored locally in your browser. No server involved.</footer>

  <script>
    // Simple helper functions
    const $ = id => document.getElementById(id);

    // Storage key
    const KEY = 'town_mosque_registry_v1';

    // State
    let mosques = []; // array of mosque objects
    let editingId = null; // if editing

    // Load from localStorage
    function load() {
      try {
        const raw = localStorage.getItem(KEY);
        mosques = raw ? JSON.parse(raw) : [];
      } catch (e) { mosques = []; }
    }

    function saveToStorage() {
      localStorage.setItem(KEY, JSON.stringify(mosques));
    }

    // Render registered mosque table
    function renderTable(filterText = '') {
      const area = $('mosqueTableArea');
      const filter = filterText.trim().toLowerCase();
      const rows = mosques.filter(m => {
        if (!filter) return true;
        return (m.name + ' ' + m.district + ' ' + (m.phone || '')).toLowerCase().includes(filter);
      });

      if (rows.length === 0) {
        area.innerHTML = '<div class="empty">No mosques found.</div>';
        return;
      }

      let html = `<table class="table"><thead><tr><th>Name</th><th>District</th><th>Phone</th><th>Members</th><th>Actions</th></tr></thead><tbody>`;
      rows.forEach(m => {
        html += `<tr>
          <td>${escapeHtml(m.name)}</td>
          <td>${escapeHtml(m.district || '')}</td>
          <td>${escapeHtml(m.phone || '')}</td>
          <td>${m.members.length}</td>
          <td>
            <button class="btn btn-ghost" onclick="editMosque('${m.id}')">Edit</button>
            <button class="btn btn-ghost" onclick="deleteMosque('${m.id}')">Delete</button>
            <button class="btn btn-ghost" onclick="viewMosque('${m.id}')">View</button>
              <button class="btn btn-ghost" onclick="downloadPDF('${m.id}')">PDF</button>

          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      area.innerHTML = html;
    }

    // Populate district filter dropdown
    function populateDistrictFilter() {
      const sel = $('filterDistrict');
      const districts = Array.from(new Set(mosques.map(m => m.district).filter(Boolean))).sort();
      sel.innerHTML = '<option value="">All Districts</option>' + districts.map(d => `<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join('');
    }

    // Preview
    function renderPreview(m) {
      const area = $('previewArea');
      if (!m) { area.innerHTML = '<div class="empty">No mosque selected — fill the form to see preview.</div>'; return; }
      area.innerHTML = `
        <div style="font-weight:600;font-size:15px">${escapeHtml(m.name)}</div>
        <div class="small">${escapeHtml(m.district || '')} • ${escapeHtml(m.area || '')}</div>
        <div style="margin-top:8px">${escapeHtml(m.address || '')}</div>
        <hr style="margin:8px 0;border:none;border-top:1px solid #f0f2f6" />
        <div style="font-weight:600">Members (${m.members.length})</div>
        <div style="margin-top:6px">${m.members.map(mem => `<div class="small">${escapeHtml(mem.name)} — ${escapeHtml(mem.phone)}</div>`).join('')}</div>
      `;
    }

    // Utility: generate id
    function id() { return 'm_' + Math.random().toString(36).slice(2,9); }

    // Utility: escape html
    function escapeHtml(s){ if (!s) return ''; return s.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // UI: members list
    function refreshMembersUI(members){
      const out = $('membersList');
      out.innerHTML = '';
      if (!members || members.length===0){ out.innerHTML = '<div class="small">No members added.</div>'; return; }
      members.forEach((mem, i) => {
        const div = document.createElement('div');
        div.className = 'member-row';
        div.innerHTML = `<div><strong>${escapeHtml(mem.name)}</strong><div class="small">${escapeHtml(mem.phone)}</div></div>
                         <div class="controls">
                           <button class="btn btn-ghost" data-action="edit" data-i="${i}">Edit</button>
                           <button class="btn btn-ghost" data-action="del" data-i="${i}">Remove</button>
                         </div>`;
        out.appendChild(div);
      });
    }

    // Form helpers
    function getFormData(){
      return {
        id: editingId || id(),
        name: $('mosqueName').value.trim(),
        district: $('mosqueDistrict').value.trim(),
        area: $('mosqueArea').value.trim(),
        phone: $('mosquePhone').value.trim(),
        email: $('mosqueEmail').value.trim(),
        address: $('mosqueAddress').value.trim(),
        members: currentMembers.slice()
      };
    }

    function setFormData(m){
      $('mosqueName').value = m.name || '';
      $('mosqueDistrict').value = m.district || '';
      $('mosqueArea').value = m.area || '';
      $('mosquePhone').value = m.phone || '';
      $('mosqueEmail').value = m.email || '';
      $('mosqueAddress').value = m.address || '';
      currentMembers = m.members ? m.members.slice() : [];
      refreshMembersUI(currentMembers);
      renderPreview(m);
    }

    function resetForm(){
      editingId = null;
      $('mosqueName').value='';$('mosqueDistrict').value='';$('mosqueArea').value='';$('mosquePhone').value='';$('mosqueEmail').value='';$('mosqueAddress').value='';
      currentMembers = [];
      refreshMembersUI(currentMembers);
      renderPreview(null);
    }

    // CRUD
    function saveMosque(){
      const data = getFormData();
      if (!data.name) { alert('Please enter mosque name'); return; }
      // if editing
      const existingIndex = mosques.findIndex(x => x.id === data.id);
      if (existingIndex >= 0) {
        mosques[existingIndex] = data;
      } else {
        mosques.push(data);
      }
      saveToStorage();
      populateDistrictFilter();
      renderTable($('searchInput').value);
      alert('Mosque saved');
      resetForm();
    }

    function editMosque(mid){
      const m = mosques.find(x => x.id === mid); if(!m) return; editingId = m.id; setFormData(m);
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function deleteMosque(mid){
      if (!confirm('Delete this mosque?')) return;
      mosques = mosques.filter(x=>x.id!==mid);
      saveToStorage(); populateDistrictFilter(); renderTable($('searchInput').value);
    }

    function viewMosque(mid){
      const m = mosques.find(x => x.id === mid); if(!m) return; renderPreview(m);
      window.scrollTo({top:0,behavior:'smooth'});
    }

    // Members handling
    let currentMembers = [];
    $('addMemberBtn').addEventListener('click', (e) => {
      const name = $('memberName').value.trim();
      const phone = $('memberPhone').value.trim();
      if (!name) { alert('Member name required'); return; }
      currentMembers.push({name, phone});
      $('memberName').value='';$('memberPhone').value='';
      refreshMembersUI(currentMembers);
    });

    // Delegate clicks for members list (edit/remove)
    document.getElementById('membersList').addEventListener('click', (e) => {
      const btn = e.target.closest('button'); if(!btn) return;
      const action = btn.dataset.action; const i = Number(btn.dataset.i);
      if (action === 'del') { currentMembers.splice(i,1); refreshMembersUI(currentMembers); }
      else if (action === 'edit') { const mem = currentMembers[i]; $('memberName').value = mem.name; $('memberPhone').value = mem.phone; currentMembers.splice(i,1); refreshMembersUI(currentMembers); }
    });

    // Save button
    $('saveMosque').addEventListener('click', saveMosque);
    $('resetForm').addEventListener('click', resetForm);

    // Search & filter
    $('searchInput').addEventListener('input', (e) => renderTable(e.target.value));
    $('filterDistrict').addEventListener('change', (e) => {
      const v = e.target.value; if (!v) return renderTable($('searchInput').value);
      renderTable(v);
    });

    // Export CSV
    $('exportBtn').addEventListener('click', () => {
      if (mosques.length === 0) { alert('No data to export'); return; }
      const rows = [];
      rows.push(['Name','District','Area','Phone','Email','Address','MembersCount','Members']);
      mosques.forEach(m => rows.push([m.name, m.district, m.area, m.phone, m.email, m.address, m.members.length, m.members.map(x=>x.name + ' ('+x.phone+')').join('; ')]));
      const csv = rows.map(r => r.map(c => '"' + (String(c).replace(/"/g,'""')) + '"').join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'mosques.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // Random fill sample
    $('randomFill').addEventListener('click', () => {
      const samples = [{name:'Al Noor Masjid',district:'Old Town',area:'Ward 1',phone:'+91 90000 11111'},{name:'Jamia Masjid',district:'New Town',area:'Ward 3',phone:'+91 90000 22222'},{name:'Masjid-e-Azza',district:'Old Town',area:'Ward 2',phone:'+91 90000 33333'}];
      const s = samples[Math.floor(Math.random()*samples.length)];
      $('mosqueName').value = s.name; $('mosqueDistrict').value = s.district; $('mosqueArea').value = s.area; $('mosquePhone').value = s.phone; $('mosqueAddress').value = 'Sample address for ' + s.name;
      currentMembers = [ {name:'Chairman', phone:'+91 90000 00001'}, {name:'Secretary', phone:'+91 90000 00002'} ];
      refreshMembersUI(currentMembers); renderPreview(getFormData());
    });

    // Clear all
    $('clearAll').addEventListener('click', () => {
      if (!confirm('Clear all saved mosques from this browser? This cannot be undone.')) return;
      mosques = []; saveToStorage(); populateDistrictFilter(); renderTable(); resetForm();
    });

    // Init
    load(); populateDistrictFilter(); renderTable();
    // PDF Download Function
function downloadPDF(mid) {
  const m = mosques.find(x => x.id === mid);
  if (!m) return alert("Mosque not found");

  // Load jsPDF from CDN if not loaded
  if (typeof jsPDF === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
    script.onload = () => createPDF(m);
    document.body.appendChild(script);
  } else {
    createPDF(m);
  }
}

function createPDF(m) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("Mosque Registration Report", 10, 15);
  doc.setFontSize(12);
  doc.text(`Name: ${m.name}`, 10, 30);
  doc.text(`District: ${m.district}`, 10, 40);
  doc.text(`Area: ${m.area || '-'}`, 10, 50);
  doc.text(`Phone: ${m.phone}`, 10, 60);
  doc.text(`Email: ${m.email || '-'}`, 10, 70);
  doc.text(`Address: ${m.address}`, 10, 80);

  doc.text("Members:", 10, 95);
  let y = 105;
  m.members.forEach((mem, i) => {
    doc.text(`${i + 1}. ${mem.name} — ${mem.phone}`, 15, y);
    y += 8;
  });

  doc.save(`${m.name.replace(/\\s+/g, '_')}.pdf`);
}

  </script>
</body>
</html>
